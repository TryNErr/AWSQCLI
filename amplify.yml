version: 1
backend:
  phases:
    build:
      commands:
        - echo "ðŸ”§ Deploying Backend API First..."
        - cd quizwiz-app
        - echo "Installing Serverless Framework..."
        - npm install -g serverless
        - echo "Installing backend dependencies..."
        - cd backend && npm install && cd ..
        - echo "Deploying backend to Lambda..."
        - serverless deploy --stage prod --region us-east-1
        - echo "âœ… Backend deployed"
        - echo "Getting API endpoint..."
        - 'API_URL=$(serverless info --stage prod --region us-east-1 | grep "HttpApiUrl" | awk "{print $2}")'
        - 'echo "API_URL=$API_URL" > ../backend-url.env'
        - 'echo "Backend API URL: $API_URL"'
frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸš€ QuizWiz Frontend Deployment"
        - cd quizwiz-app/frontend
        - echo "Installing dependencies..."
        - npm install
        - echo "âœ… Dependencies installed"
    build:
      commands:
        - echo "ðŸ”¨ Building React application..."
        - echo "Loading backend API URL..."
        - 'if [ -f ../../backend-url.env ]; then source ../../backend-url.env; fi'
        - 'echo "REACT_APP_API_URL=${API_URL:-https://placeholder.execute-api.us-east-1.amazonaws.com/prod}" > .env.production.local'
        - 'echo "REACT_APP_ENVIRONMENT=production" >> .env.production.local'
        - 'echo "GENERATE_SOURCEMAP=false" >> .env.production.local'
        - 'echo "Using API URL: ${API_URL}"'
        - npm run build
        - echo "âœ… Build completed"
    postBuild:
      commands:
        - echo "ðŸ“¦ Verifying build..."
        - test -f build/index.html && echo "âœ… index.html exists" || exit 1
        - echo "ðŸŽ‰ Full-stack deployment complete"
  artifacts:
    baseDirectory: quizwiz-app/frontend/build
    files:
      - '**/*'
  cache:
    paths:
      - quizwiz-app/frontend/node_modules/**/*
      - quizwiz-app/backend/node_modules/**/*
