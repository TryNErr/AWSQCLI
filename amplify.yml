version: 1
backend:
  phases:
    build:
      commands:
        - echo "ðŸ”§ Amplify Gen 2 Backend Deployment"
        - cd amplify
        - npm install
        - npm run build
        - echo "âœ… Backend compiled"
frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸš€ QuizWiz Frontend Deployment"
        - cd ../quizwiz-app/frontend
        - npm install
        - echo "âœ… Dependencies installed"
    build:
      commands:
        - echo "ðŸ”¨ Building React application..."
        - echo "Looking for Amplify outputs..."
        - find /tmp -name "*outputs*" -type f 2>/dev/null | head -5
        - ls -la ../amplify/ 2>/dev/null || echo "No amplify dir"
        - API_URL=$(find /tmp -name "*outputs*" -exec grep -l "endpoint" {} \; 2>/dev/null | head -1 | xargs cat 2>/dev/null | grep -o 'https://[^"]*' | head -1 || echo "https://placeholder-api.execute-api.us-east-1.amazonaws.com/prod")
        - echo "Found API URL: ${API_URL}"
        - echo "REACT_APP_API_URL=${API_URL}" > .env.production.local
        - echo "REACT_APP_ENVIRONMENT=production" >> .env.production.local
        - echo "GENERATE_SOURCEMAP=false" >> .env.production.local
        - cat .env.production.local
        - npm run build
        - echo "âœ… Build completed"
    postBuild:
      commands:
        - test -f build/index.html && echo "âœ… Frontend ready" || exit 1
        - echo "ðŸŽ‰ Full-stack deployment complete"
  artifacts:
    baseDirectory: quizwiz-app/frontend/build
    files:
      - '**/*'
  cache:
    paths:
      - quizwiz-app/frontend/node_modules/**/*
      - amplify/node_modules/**/*
