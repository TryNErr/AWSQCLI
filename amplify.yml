version: 1
backend:
  phases:
    build:
      commands:
        - echo "ðŸ”§ Deploying Backend Lambda"
        - cd quizwiz-app
        - npm install -g serverless
        - cd backend && npm install && cd ..
        - serverless deploy --stage prod --region ap-southeast-2 > deploy-output.txt
        - API_URL=$(grep -o 'https://[^[:space:]]*' deploy-output.txt | head -1)
        - echo "Backend API URL: $API_URL"
        - echo "$API_URL" > ../backend-api-url.txt
        - echo "âœ… Backend Lambda deployed"
frontend:
  phases:
    preBuild:
      commands:
        - echo "ðŸš€ Building Static React Frontend"
        - cd quizwiz-app/frontend
        - npm install
        - echo "âœ… Dependencies installed"
    build:
      commands:
        - echo "ðŸ”¨ Building React with backend API..."
        - API_URL=$(cat ../../backend-api-url.txt || echo "https://placeholder-api.execute-api.ap-southeast-2.amazonaws.com/prod")
        - echo "REACT_APP_API_URL=$API_URL" > .env.production.local
        - echo "REACT_APP_ENVIRONMENT=production" >> .env.production.local
        - echo "GENERATE_SOURCEMAP=false" >> .env.production.local
        - cat .env.production.local
        - npm run build
        - echo "âœ… Static frontend built"
    postBuild:
      commands:
        - test -f build/index.html && echo "âœ… Frontend ready for CDN" || exit 1
        - echo "ðŸŽ‰ Full-stack Lambda + Static deployment complete"
  artifacts:
    baseDirectory: quizwiz-app/frontend/build
    files:
      - '**/*'
  cache:
    paths:
      - quizwiz-app/frontend/node_modules/**/*
