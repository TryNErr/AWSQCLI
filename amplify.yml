version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "ğŸš€ Starting QuizWiz deployment..."
        - echo "Amplify Environment Variables:"
        - echo "App ID:" $AWS_APP_ID
        - echo "Branch:" $AWS_BRANCH  
        - echo "Region:" $AWS_DEFAULT_REGION
        - cd quizwiz-app/frontend
        - echo "Installing frontend dependencies..."
        - npm ci --production=false
        - echo "âœ… Frontend dependencies installed"
    build:
      commands:
        - echo "ğŸ”¨ Building React application..."
        - cd quizwiz-app/frontend
        - echo "Setting up dynamic environment variables..."
        # Use Amplify's built-in variables to construct API URL
        - |
          if [ -n "$AWS_APP_ID" ]; then
            API_URL="https://${AWS_APP_ID}.execute-api.${AWS_DEFAULT_REGION:-us-east-1}.amazonaws.com/prod"
            echo "REACT_APP_API_URL=$API_URL" > .env.production.local
          else
            echo "REACT_APP_API_URL=https://api.placeholder.com" > .env.production.local
          fi
        - echo "REACT_APP_ENVIRONMENT=production" >> .env.production.local
        - echo "REACT_APP_AMPLIFY_APP_ID=${AWS_APP_ID:-unknown}" >> .env.production.local
        - echo "REACT_APP_BRANCH=${AWS_BRANCH:-main}" >> .env.production.local
        - echo "GENERATE_SOURCEMAP=false" >> .env.production.local
        - echo "Environment configuration:"
        - cat .env.production.local
        - npm run build
        - echo "âœ… Build completed successfully"
    postBuild:
      commands:
        - echo "ğŸ“¦ Post-build verification..."
        - cd quizwiz-app/frontend
        - test -f build/index.html && echo "âœ… index.html found" || echo "âŒ index.html missing"
        - test -d build/static && echo "âœ… static assets found" || echo "âŒ static assets missing"
        - echo "ğŸ‰ QuizWiz frontend deployment ready!"
  artifacts:
    baseDirectory: quizwiz-app/frontend/build
    files:
      - '**/*'
  cache:
    paths:
      - quizwiz-app/frontend/node_modules/**/*
